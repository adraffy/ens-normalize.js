<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ENS Resolver</title>
<style>
.hide {
	display: none !important;
}
a, button {
	cursor: pointer;
}
body { 
	margin: 3rem; 
	background: #eee;
	display: flex;
	flex-direction: column;
	gap: 0.7rem;
}
header {
	display: flex;
	justify-content: space-between;
}
h1 {
	display: flex;
	flex-wrap: wrap;
	flex-basis: 50%;
	align-items: baseline;
	margin: 0;
	gap: 0.5rem;
}
h1 a {
	font-size: 24pt;
	white-space: pre;
}
#provider {
	font-size: 12pt;
	font-weight: normal;
	color: #666;
}
#version {
	text-align: right;
	box-sizing: border-box;
}
.arrows {
	width: 1.5rem;
	height: 1.5rem;
	animation: spin 2s infinite linear;
	user-select: none;
	background: url('data:image/svg+xml;utf8,%3Csvg%20viewBox%3D%220%200%201000%201000%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M990%2C377.5H622.5l137.4-137.4C690.4%2C170.7%2C598.2%2C132.5%2C500%2C132.5c-98.2%2C0-190.4%2C38.2-259.9%2C107.6C170.7%2C309.6%2C132.5%2C401.8%2C132.5%2C500c0%2C98.2%2C38.2%2C190.4%2C107.6%2C259.9c69.4%2C69.4%2C161.7%2C107.6%2C259.9%2C107.6c98.2%2C0%2C190.4-38.2%2C259.9-107.6c5.8-5.8%2C11.4-11.8%2C16.7-17.9l92.2%2C80.7C778.9%2C925.2%2C647%2C990%2C500%2C990C229.4%2C990%2C10%2C770.6%2C10%2C500C10%2C229.4%2C229.4%2C10%2C500%2C10c135.3%2C0%2C257.8%2C54.9%2C346.5%2C143.5L990%2C10V377.5z%22%2F%3E%3C%2Fsvg%3E');
	background-size: contain;
	background-repeat: no-repeat;
}
@keyframes spin {
	from { transform:rotate(0deg); }
	to	 { transform:rotate(360deg); }
}
.examples {
	display: flex;
	flex-wrap: wrap;
	align-items: center;
	gap: 3px;
}
#input label {
	display: none;
}
#input input {
	box-sizing: border-box;
	width: 100%;
	padding: 0.5rem;
	font-size: 16pt;
}
#controls {
	display: flex;
	align-items: center;
	gap: 0.5rem;
}
#controls button {
	align-self: stretch;
	padding: 0.2rem;
}
input[type=checkbox], label {
	user-select: none;
	cursor: pointer;
}
input[type=checkbox]:checked + label.nonstd {
	background: #f00;
	color: #fff;
	outline: 2px solid #f00;
	border-radius: 5px;
}
#controls .balloon {
	flex-grow: 1;
}
#resolve_btn {
	font-size: 16pt;
	font-weight: bold;
}
#link button {
	font-size: 14pt;
}
button.main {
	font-weight: bold;
	font-size: 100%;
}
#output {
	display: flex;
	flex-direction: column;
	gap: 0.7rem;
	font-size: 14pt;
}
.row-label {
	text-align: right;
	font-weight: bold;
	white-space: pre-wrap;
}
.row {
	padding: 0.7rem;
	background: #fff;
	display: flex;
	align-items: center;
	gap: 0.5rem;
}
.row.display {
	background: #ffc;
}
.row.normalized {
	background: #efe;
}
.row.owner {
	background: #fed;
}
ul.row {
	flex-direction: column;
	align-items: start;
	margin: 0;
	padding-left: 2rem;
	background: #ffc;
}
.hash {
	line-break: anywhere;
}
.exploded {
	display: flex;
	flex-wrap: wrap;
	gap: 0.5rem;
}
.tags sub {
	padding-left: 0.1rem;
}
.tags {
	display: flex;
	flex-wrap: wrap;
	gap: 0.5rem;
	align-items: center;
}
.tags button {
	align-self: stretch;
}
.tags span {
	background: #ddd;
	color: #555;
	padding: 0.2rem 0.5rem;
	font-size: 12pt;
	border-radius: 0.5rem;
	border: 1px solid #ccc;
	white-space: pre;
}
.tags .long {
	white-space: normal;
}
.tags .ens {
	order: 9;
}
.tags .opensea {
	order: 8;
}
.tags .elapsed {
	background: #cff;
	font-size: 80%;
	order: 10;
}
.tags .length {
	order: -10;
	background: #fff;
}
.tags .length:hover {
	cursor: pointer;
	background: #eee;
}
.tags .bytes {
	order: -10;
	background: #eee;
}
.tags .okay {
	background: #ffc;
}
.tags .good {
	color: #060;
	background: #cfc;
}
.tags .best {
	color: #060;
	background: #cfc;
	font-weight: bold;
	border-color: #060;
}
.tags .warn {
	background: #ffc;
}
.tags .fail {
	background: #fcc;
	color: #600;
}
.row.hashes {
	display: grid;
	background: none;
	padding: 0 0.5rem;
	grid-template-columns: 20% 30% auto;
	align-items: start;
	gap: 0.5rem;
	font-size: 12pt;
	box-sizing: border-box;
	width: 100%;
}
.hashes .text {
	line-break: anywhere;
	text-align: center;
}
.hashes .cp {
	white-space: break-spaces;
}
.hashes .name {
	grid-column: 1 / -1;
	text-align: center;
} 
.tokens {
	font-size: 16pt;
}
.error {
	background: #fcc;
	border: 3px dashed #f00;
}
footer {
	text-align: center;
	color: #666;
	margin-bottom: 0.5rem;
}
@media only screen and (max-width: 800px) { 
	body {
		margin: 0;
	}
	button {
		font-size: 100%;
	}
	header {
		margin: 1rem 1rem 0 1rem;
	}
	#input, #controls, #options, .examples {
		margin: 0 1rem;
	}
	.error {
		border-left: 0;
		border-right: 0;
	}
}
</style>
</head>
<body>
<header>
<h1><a href="https://ens.domains/">ENS Resolver</a><span id="provider"></span></h1>
<span id="version"><a href="https://github.com/adraffy/ens-normalize.js">@adraffy/ens-normalize</a></span>
</header>
<div class="examples">
<button>vitalik.eth</button>
<button>bRAnTlY.eTh</button>
<button>brantly.cash</button>
<button>brantlymillegan.com</button>
<button>.eth</button>
<button>Ã¶bb.at</button>
<button>Ã–bb.at</button>
<button>â—ŒÌˆbb.at</button>

<b>Puny:</b>
<button>xn--ls8h</button>
<button>xn--bb-eka</button>

<b>Subdomain:</b>
<button data-name="nowzad.loopring.eth">loopring</button>

<b>Display:</b>
<button>ADRaffy</button>

<b>Address:</b>
<button data-name="0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045">d8dA..6045</button>

<b>Mapped:</b> 
<button>â…§</button>

<b>Ignored:</b> 
<button data-name="{FE0E}{FE0F}">Emoji Style</button>

<b>Deviation:</b> 
<button>ÃŸ</button>
<button>Ï‚</button>

<b>Disallowed:</b>
<button>te[st</button>
<button>tes_t</button>

<a href="https://unicode.org/reports/tr46/#Validity_Criteria"><b>CheckHyphen:</b></a>
<button>-test</button>
<button>test-</button>
<button>te--st</button>

<b>Goofy:</b>
<button data-name="[ba967c160905ade030f84952644a963994eeaed3881a6b8a4e9c8cbe452ad7a2].eth" data-skip="1">"ğŸ’©.eth"</button>

<a href="./report-emoji.html#ZWJ%20Sequences"><b>Emoji:</b></a>
<button>ğŸš€ğŸš€ğŸš€</button>
<button>ğŸ’©ğŸ’©ğŸ’©</button>
<button>ğŸš´â€â™‚ï¸</button>
<button>ğŸ‘ï¸â€ğŸ—¨ï¸</button>
<button>ğŸŒˆrainbow</button>
<button>6ï¸âƒ£9ï¸âƒ£</button>
<button>ğŸ³ï¸â€ğŸŒˆ</button>
<button>ğŸ§Ÿâ€â™‚</button>
<button>ğŸ§Ÿâ™‚</button>
<button>ğŸ˜µâ€ğŸ’«ğŸ˜µâ€ğŸ’«ğŸ˜µâ€ğŸ’«</button>
<button>ğŸ˜µğŸ’«ğŸ˜µğŸ’«ğŸ˜µğŸ’«</button>
<button>ğŸ‘©ğŸ½â€âš•ï¸</button>
<button>ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦</button>
<button>ğŸ‘¨ğŸ‘©ğŸ‘¦</button>
<button>ğŸŸ§ğŸŸ§ğŸŸ§</button>

<a href="./report-emoji.html"><b>Picto:</b></a>
<button>mmm</button>
<button>â“‚â“‚â“‚</button>
<button>â“‚ï¸â“‚ï¸â“‚ï¸</button>
<button>ğŸ…œğŸ…œğŸ…œ</button>
<button>ğŸ…¼ğŸ…¼ğŸ…¼</button>
<button>â»â»â»</button>
<button>âââ</button>

<a href="https://datatracker.ietf.org/doc/html/rfc5892#appendix-A.1"><b>ContextJ:</b></a>
ZWNJ:
<button data-name="a{94D}{200C}">âœ… #1</button>
<button data-name="{843}{8ED}{200C}{7F2}{713}">âœ… #2</button>
<button data-name="a{200C}b">âŒ</button>
<button data-name="ğŸ§{200C}{200C}">"ğŸ§.eth"</button>
â€¢ 
ZWJ:
<button data-name="a{94D}{200D}">âœ…</button>
<button data-name="a{200D}b">âŒ</button>
<a href="https://datatracker.ietf.org/doc/html/rfc5892#appendix-A.3"><b>ContextO:</b></a>
Middle Dot: 
<button data-name="{6C}{B7}{6C}">âœ…</button>
<button data-name="a{B7}b">âŒ</button>
â€¢ 
Greek Keraia: 
<button data-name="ab{375}{0377}">âœ…</button>
<button data-name="ab{375}">âŒ</button>
â€¢ 
Hebrew Geresh 
<button data-name="{05D1}{0591}{5F3}">âœ…</button>
<button data-name="ab{5F3}">âŒ</button>
â€¢ 
Katakana:
<button data-name="{3041}{30A1}{30FB}">âœ…</button>
<button data-name="ab{30FB}">âŒ</button>
â€¢ 
Arabic-Indic:
<button data-name="{5D0}{660}{661}{662}">âœ…</button>
<button data-name="{5D0}{6F0}{6F1}{6F2}">âœ…</button>
<button data-name="{660}{6F0}.eth">âŒ</button>
<a href="https://www.rfc-editor.org/rfc/rfc5893.html#section-2"><b>CheckBidi:</b></a>
<button data-name="{202e}elgoog{202d}.eth" data-replace="1"></button>
<button data-name="{202e}hte.elgoog" data-replace="1"></button>
<button>×¤×¢×™×œ×•×ª×”×‘×™× ××•×</button>
<button data-name="{0786}{07AE}{0782}{07B0}{0795}{07A9}{0793}{07A6}{0783}{07AA}">Dhivehi</button>
<button data-name="{05D9}{05B4}{05D5}{05D0}{05B8}">Yiddish</button>
<button data-name="bahrainÙ…ØµØ±">âŒ Mixed LTR+RTL in Label</button>
<button data-name="bahrain.Ù…ØµØ±">Separate LTR and RTL Labels</button>
<b>Revived:</b>
<button>â€¼ï¸â€¼ï¸â€¼ï¸</button>
<button>â‰ï¸â‰ï¸â‰ï¸</button>
<button>*ï¸âƒ£</button>
<button>#ï¸âƒ£</button>
</div>
<div id="options">
<label><input type="checkbox" id="auto_resolve_check" checked>Resolve on Input</label>
<label><input type="checkbox" id="show_hashes_check" checked>Show Hashes</label>
<span><input type="checkbox" id="skip_norm_check"><label class="nonstd" for="skip_norm_check">Skip Normalization</label></span>
<span><input type="checkbox" id="ignore_disallowed_check"><label class="nonstd" for="ignore_disallowed_check">Ignore Disallowed Characters</label></span>
<span><input type="checkbox" id="ignore_bidi_check"><label class="nonstd" for="ignore_bidi_check">Disable CheckBidi</label></span>
</div>
<div id="input">
<label for="input_field">Name or Address:</label>
<input id="input_field" size="20" placeholder="Name or Address (Checksummed)">
</div>
<div id="controls">
<div class="arrows hide"></div>
<span class="balloon"></span>
<button id="escape_btn">Escape</button>
<button id="link_btn">Copy Link</button>
<button id="resolve_btn">Resolve</button>
</div>
<div id="output">
<ul class="row">
<li>Click an <button data-name="bRANtly.eth">Example</button> to see how it works.</li>
<li>Use <code>{FF}</code> or <code>[255]</code> to manually include codepoints, eg. <button data-escape="1" data-name="a{200D}b.eth">ZWJ</button></li>
<li><b>Copy Link</b> to get a URL that resolves on page-load.</li>
</ul>
</div>
<footer>Created by <a href="https://twitter.com/adraffy">raffy.eth</a></footer>
<script type="module">
import {
	Providers, FetchProvider, 
	determine_window_provider, source_from_provider,
	is_checksum_address, namehash, labelhash, ENS
} from '../../eth-tools.js/dist/eth-tools.min.js';
import {escape_name_for_html, is_printable_ascii, explode_cp, hex_cp} from '../build/utils.js';
import {ens_normalize, ens_tokenize, VERSION, BUILT, IDNA, UNICODE} from '../dist/ens-normalize-debug.min.js';
import {ens_normalize as ens_normalize_xbidi} from '../dist/ens-normalize-xbidi.min.js'; // load without bidi
import {dom_from_tokens, use_default_style} from '../dist/parts.min.js';

let providers = new Providers().add_static(1, new FetchProvider({url: 'https://cloudflare-eth.com'}));
let window_provider;
determine_window_provider().then(p => {
	window_provider = p;
	providers.add_dynamic(p);
}).catch(() => {});

let ens = new ENS({provider: providers.view(1)});

document.querySelector('#version').innerHTML += ` (v${VERSION}+${IDNA}+U${UNICODE})<br><code>${BUILT}</code>`;

use_default_style();

const input_field = document.querySelector('#input_field');
const resolve_btn = document.querySelector('#resolve_btn');
const arrows = document.querySelector('#controls .arrows');
const auto_resolve_check = document.querySelector('#auto_resolve_check');
const skip_norm_check = document.querySelector('#skip_norm_check');
const ignore_disallowed_check = document.querySelector('#ignore_disallowed_check');
const ignore_bidi_check = document.querySelector('#ignore_bidi_check');
const show_hashes_check = document.querySelector('#show_hashes_check');
const output_div = document.querySelector('#output');
const readme_rows = [...output_div.childNodes]; // save initial ux

let resolve_timer;

function ens_normalize_input(name) {
	if (ignore_disallowed_check.checked) {
		name = String.fromCodePoint(...ens_tokenize(name).flatMap(({v,i,m,e,u,d}) => v ?? i ?? (m?u:null) ?? (e?u:null) ?? (d===undefined ? 0x2E : [])));
	}
	if (ignore_bidi_check.checked) {
		return ens_normalize_xbidi(name);
	} else {
		return ens_normalize(name);
	}
}

for (let btn of document.querySelectorAll('.examples button, button[data-name]')) {
	let name = replace_escapes(btn.dataset.name ?? btn.innerHTML);
	if (btn.dataset.replace) btn.innerHTML = name;
	if (!name.includes('.') && !is_checksum_address(name)) name += '.eth';
	if (btn.dataset.escape) name = apply_escapes(name, false);
	btn.addEventListener('click', () => {
		input_field.value = name;
		resolve(btn.dataset.skip);
	});
}

resolve_btn.addEventListener('click', () => resolve());
input_field.addEventListener('keydown', e => {
	if (e.key === 'Enter') {
		e.stopPropagation();
		resolve();
	}
});
input_field.addEventListener('input', () => {
	if (parse()) schedule_resolve();
});

document.querySelector('#escape_btn').addEventListener('click', () => {
	let s0 = input_field.value;
	let s1 = replace_escapes(s0);
	let s2 = apply_escapes(s1);
	let s3 = apply_escapes(s1, true);
	let set = [...new Set([s1, s2, s3])];
	let pos = set.indexOf(s0);	
	input_field.value = set[(pos + 1) % set.length];
});

document.querySelector('#link_btn').addEventListener('click', () => {
	navigator.clipboard.writeText(window.location.href.split('#')[0] + '#' + encodeURIComponent(input_field.value));
});

for (let el of [auto_resolve_check, ignore_disallowed_check, ignore_bidi_check, skip_norm_check]) {
	el.addEventListener('input', () => {
		if (auto_resolve_check.checked && input_field.value) {
			if (parse()) schedule_resolve();
		}
	});
}
show_hashes_check.addEventListener('input', () => {	
	for (let el of document.querySelectorAll('.hashes')) {
		el.classList.toggle('hide', !show_hashes_check.checked);
	}
});

input_field.focus();
input_field.value = decode_location_hash();
schedule_resolve(100);
window.addEventListener('hashchange', () => {
	input_field.value = decode_location_hash();
	resolve();
});

function decode_location_hash() {
	return decodeURIComponent(window.location.hash.slice(1));
}

function schedule_resolve(t = 1000) {
	if (is_working()) {
		resolve_timer = true;
	} else if (!resolve_timer && auto_resolve_check.checked) {
		resolve_timer = setTimeout(resolve, t);
		arrows.classList.remove('hide');
	}
} 

function parse() {
	output_div.innerHTML = '';
	let name = replace_escapes(input_field.value);
	if (!name) {
		clearTimeout(resolve_timer);
		resolve_timer = 'null';
		arrows.classList.add('hide');
		output_div.append(...readme_rows);
		return;
	}
	if (resolve_timer === 'null') {
		resolve_timer = false;
	}
	if (is_checksum_address(name)) {
		let row = create_row('Address');
		row.append(create_etherscan_address_link(name));
		output_div.append(row);
		return true;
	}
	let row = create_exploded_row('Input', name, false, ignore_disallowed_check.checked);
	let grade = document.createElement('span');	
	apply_input_grade(grade, name);
	add_row_tag(row, grade);
	output_div.append(row, create_hashes_row(name));
	try {
		let norm = ens_normalize_input(name);
		if (norm !== name) {
			let norm_row = create_exploded_row('Normalized', norm, true);
			norm_row.classList.add('normalized');
			output_div.append(norm_row, create_hashes_row(norm));
		}
		return true;
	} catch (err) {
		row.classList.add('error');
		grade.classList.add('long');
		apply_warn_grade(grade, err.message);
	}
}


function apply_escapes(s, forced) {
	return [...s].map(x => !forced && is_printable_ascii(x) ? x : `{${hex_cp(x.codePointAt(0))}}`).join('');
}
function replace_escapes(s) {
	// match: {HEX}, [0xHEX], [DEC]
	return s.replace(/(?:(?:\{([0-9a-f]+)\})|(?:\[((?:0x[0-9a-f]+)|[0-9]+)\]))/uig, (_, a, b) => {
		try {
			return String.fromCodePoint(a ? parseInt(a, 16) : parseInt(b)); 
		} catch (err) {
			return '\u{FFFD}';
		}
	});
}

function create_link(url, s) {
	let a = document.createElement('a');
	a.href = url;
	a.innerHTML = s ?? url;
	return a;
}
function create_etherscan_address_link(s) {
	let a = create_link(`https://etherscan.io/address/${s}`, s);
	a.classList.add('hash');
	return a;	
}
function create_copy_btn(s, title = 'Copy') {
	let btn = document.createElement('button');
	btn.addEventListener('click', () => navigator.clipboard.writeText(s));
	btn.innerHTML = title;
	return btn;
}
function create_ens_link(s) {
	let a = create_link(`https://app.ens.domains/name/${encodeURIComponent(s)}`, 'ENS');
	a.classList.add('ens');
	a.title = `ENS: ${s}`;
	return a;
}
function get_dot_eth_label(name) {
	let v = name.split('.');
	return v.length == 2 && v[1] == 'eth' ? v[0] : undefined;
}
function create_opensea_link(name) {
	// add opensea if ENS
	let label = get_dot_eth_label(name);
	if (!label) return;
	let a = create_link(`https://opensea.io/assets/0x57f1887a8bf19b14fc0df6fd9b2acc9af147ea85/${labelhash(label).hex}`, 'Opensea');
	a.classList.add('opensea');
	return a;
}

function create_exploded_row(label, name, is_norm, downgrade_disallowed) {	
	let tokens_div = dom_from_tokens(ens_tokenize(name), is_norm);
	if (downgrade_disallowed) {
		for (let x of tokens_div.querySelectorAll('.disallowed')) {
			x.classList.add('ignored');
			x.classList.remove('disallowed');
		}
	}
	let tags = document.createElement('div');
	tags.classList.add('tags');
	let n_cp = [...name].length;
	let n_u8 = unescape(encodeURIComponent(name)).length;
	let count = document.createElement('span');
	count.classList.add('length');		
	count.addEventListener('click', () => {
		input_field.value = apply_escapes(name);
	});
	tags.append(count);
	if (n_cp != n_u8) {
		count.innerHTML = `${n_cp}<sub>ch</sub>`;	
		let bytes = document.createElement('span');
		bytes.classList.add('bytes');
		bytes.innerHTML = `${n_u8}<sub>bytes</sub>`;
		tags.append(bytes); 
	} else {
		count.innerHTML = `${n_cp}<sub>chytes</sub>`;
		count.title = '1-byte Characters';
	}	
	let exploded = document.createElement('div');
	exploded.classList.add('exploded');
	exploded.append(tokens_div, tags);
	let row = create_row(label);
	row.append(exploded);
	return row;
}

function apply_warn_grade(span, s) {
	span.classList.add('warn');
	span.innerHTML = `âš ï¸ ${s}`;
}
function apply_best_grade(span, s) {
	span.classList.add('best');
	span.innerHTML = `âœ…ï¸ ${s}`;
}
function apply_fail_grade(span, s) {
	span.classList.add('fail');
	span.innerHTML = `âŒ ${s}`;
}
function apply_input_grade(span, name) {
	span.classList.add('okay');
	if (is_printable_ascii(name)) {
		if (/^[a-z0-9\.]*$/u.test(name)) {
			span.innerHTML = 'Base36';
		} else if (/^[a-z0-9\.]*$/iu.test(name)) {
			span.innerHTML = 'Mixed-case Base36';
		} else if (name.toLowerCase() === name) {
			span.innerHTML = 'ASCII';
		} else {
			span.innerHTML = 'Mixed-case ASCII';
		}
	} else {
		span.innerHTML = 'Unicode';
	}
}

function create_hashes_row(name) {
	let row = create_row();
	row.classList.add('hashes');
	row.classList.toggle('hide', !show_hashes_check.checked);
	// build table of label hashes
	let labels = name.split('.');
	for (let i = 0; i < labels.length; i++) {
		let label = labels[i];
		let text = document.createElement('span');
		text.classList.add('text');
		text.innerHTML = label;
		let points = document.createElement('span');
		points.classList.add('cp');		
		points.innerHTML = label.length == 0 ? 'null' : [...label].map(x => x.codePointAt(0).toString(16).toUpperCase().padStart(2, '0')).join(' ');		
		let hash = document.createElement('span');
		hash.classList.add('hash');
		hash.innerHTML = labelhash(label).hex;
		row.append(text, points, hash);
	}
	// add namehash
	let hash = document.createElement('span');
	hash.classList.add('name', 'hash');
	hash.innerHTML = `<b>Namehash:</b> ${namehash(name).hex}`;
	row.append(hash);
	return row;
}


function output_append(row) {
	if (resolve_timer) return;
	output_div.append(row);
}

function create_row(label) {
	let row = document.createElement('div');
	row.classList.add('row');
	if (label) {
		row.append(create_row_label(label));
	}
	return row;
}

function create_error_row(label, error, long = true) {
	let span = document.createElement('span');
	if (long) span.classList.add('long');
	apply_warn_grade(span, error);
	let row = create_row(label);
	row.classList.add('error');
	add_row_tag(row, span);
	return row;
}

function create_row_label(label) {
	let span = document.createElement('span');
	span.classList.add('row-label');
	span.innerHTML = `${label}:`;
	return span;
}

function add_row_tag(row, tag) {
	if (!tag) return;
	let tags = row.querySelector('.tags');
	if (!tags) {
		tags = document.createElement('div');
		tags.classList.add('tags');
		row.append(tags);
	}
	tags.append(tag);
	return true;
}

function format_dur(t) {
	if (t < 1000) return `${Math.ceil(t)}ms`;
	t /= 1000;
	if (t < 60) return `${t.toFixed(1)}sec`;
	t /= 60;
	return `${t.toFixed(1)}min`;
}

function is_working() {
	return resolve_btn.disabled;
}

function resolve(...a) {
	if (is_working()) return;
	clearTimeout(resolve_timer);
	resolve_timer = undefined;
	let input = input_field.value;
	const title = 'ENS Resolver';
	if (!input) {
		if (window.location.hash) {
			window.history.pushState(null, null, ' ');
		} else {
			window.history.replaceState(null, null, ' ');
		}
		document.title = title;
		parse();
		return;
	}
	window.location = '#' + encodeURIComponent(input);
	document.title = `${title}: ${input}`;
	resolve_btn.disabled = true;
	arrows.classList.remove('hide');
	resolve0(input, ...a).then(() => {
		resolve_btn.disabled = false;
		if (resolve_timer === true) { // schedule again
			resolve_timer = false;
			schedule_resolve();
		} else {
			arrows.classList.add('hide');
		}
	});
}
async function resolve0(name0, override_skip_norm) {
	let date0 = new Date();
	function create_elapsed() {
		let now = new Date();
		let span = document.createElement('span');
		span.classList.add('elapsed');
		span.innerHTML = format_dur(now - date0);
		date0 = now;
		return span;
	}
	output_div.innerHTML = '';

	document.querySelector('#provider').innerHTML = `using ${await ens.get_provider().then(source_from_provider)}`;

	// replace escapes
	let input_name = replace_escapes(name0);
	let input_norm = false;
	let input_grade = document.createElement('span');
	
	let name;
		
	let skip_norm = override_skip_norm || skip_norm_check.checked;
	let address;
	
	if (is_checksum_address(input_name)) {
		
		let input_row = create_row('Address');
		input_row.append(create_etherscan_address_link(input_name));
		output_append(input_row);
		
		// resolve as an address
		name = await ens.resolve(input_name, true); 

	} else {
	
		// create name row
		let input_row = create_exploded_row('Input', input_name, false, ignore_disallowed_check.checked);
		apply_input_grade(input_grade, input_name);
		add_row_tag(input_row, input_grade);
		add_row_tag(input_row, create_ens_link(input_name));
		add_row_tag(input_row, create_opensea_link(input_name));
		output_append(input_row);

		// create name hashes
		let input_hashes = create_hashes_row(input_name);
		output_append(input_hashes);

		let norm_ens_btn;
		if (skip_norm) {
			input_norm = input_name; // yolo

			// add a warning
			let span = document.createElement('span');
			apply_fail_grade(span, 'Skipped');

			// create norm row
		 	let norm_row = create_row('Normalization');
			add_row_tag(norm_row, span);
			output_append(norm_row);

		} else {	

			// normalize the name
			try {
				input_norm = ens_normalize_input(input_name);
			} catch (err) {
				input_row.classList.add('error');
				apply_warn_grade(input_grade, err.message);
				input_grade.parentNode.prepend(input_grade);
				return;
			}	
			let norm_row = create_exploded_row('Normalized', input_norm, true);
			norm_row.classList.add('normalized');
			if (input_norm === input_name) { // already normalized
				input_grade.innerHTML = 'Normalized';
				input_grade.classList.add('good');

				add_row_tag(norm_row, input_row.querySelector('.ens')); // steal it
				output_append(norm_row);
				output_append(input_hashes); // steal it
			} else {
				// add warning to input
				let span = document.createElement('span');
				span.classList.add('fail');
				span.innerHTML = 'âŒ Normalized';
				add_row_tag(input_row, span);
		
				// add norm row
				add_row_tag(norm_row, create_copy_btn(input_norm));
				norm_ens_btn = create_ens_link(input_norm);
				add_row_tag(norm_row, norm_ens_btn);
				add_row_tag(norm_row, create_opensea_link(input_norm));
				output_append(norm_row);
		
				// show different labels
				output_append(create_hashes_row(input_norm));
			}
		}

		// resolve as a name
		name = await ens.resolve(input_norm, false);
		if (resolve_timer) return;
		if (name.error) {
			output_append(create_error_row('Resolver', name.error));
			return;
		}
		
		if (!name.resolver) {
			output_append(create_error_row('Resolver', `ENS Name Not Found`, true));
			let label = get_dot_eth_label(input_norm);
			if (label) {
				try {
					let available = await ens.is_dot_eth_available(label);
					if (resolve_timer) return;
					let row = create_row('Availability');
					let span = document.createElement('span');
					if (available) {
						if ([...label].length < 3) {
							apply_warn_grade(span, `Too Short`);
						} else {
							span.classList.add('good');
							span.innerHTML = 'Available';
						}
					} else {
						apply_fail_grade(span, `Not Available`);
					}
					add_row_tag(row, span);
					norm_ens_btn?.remove();// remove duplicate
					add_row_tag(row, create_ens_link(input_norm));
					output_append(row);
				} catch (err) {
					output_append(create_error_row('Available', err.message));
				}
			}			
			return;
		}

		// add address
		let resolver_row = create_row('Resolver');
		resolver_row.append(create_etherscan_address_link(name.resolver));
		add_row_tag(resolver_row, create_elapsed());
		output_append(resolver_row);

		// check display name
		let display_name = await name.get_text('display').catch(() => false);
		if (resolve_timer) return;
		if (display_name && display_name != input_norm) {
			let row = create_exploded_row('Display', display_name, false);
			row.classList.add('display');
			try {
				let display_norm = ens_normalize(display_name);
				if (display_norm == input_norm) {
					let fake_tokens = dom_from_tokens([{v:explode_cp(display_name)}], true);
					let prev_tokens = row.querySelector('.tokens');
					prev_tokens.parentNode.replaceChild(fake_tokens, prev_tokens);
					apply_best_grade(input_grade, 'Matches Display');
					input_row.querySelector('.ens')?.remove(); // no purpose
					input_row.querySelector('.opensea')?.remove(); // no purpose
				} else {
					let span = document.createElement('span');
					apply_warn_grade(span, `Does Not Match`);
					add_row_tag(row, span);
					row.classList.add('error');
				}
			} catch (err) {
				let span = document.createElement('span');
				apply_fail_grade(span, `Normalized: ${err.message}`);
				add_row_tag(row, span);
			}
			add_row_tag(row, create_elapsed());
			output_append(row);
		}		
		
		// add address
		let address;
		try {
			address = await name.get_address();
		} catch (err) {
			output_append(create_error_row('Address', err.message));
		}
		if (resolve_timer) return;
		let address_row = create_row('Address');
		address_row.append(create_etherscan_address_link(address));
		add_row_tag(address_row, create_elapsed());
		output_append(address_row);

		let owner;
		try {
			owner = await name.get_owner();		
		} catch (err) {
			output_append(create_error_row('Owner', err.message));
		}
		if (resolve_timer) return;
		if (owner === address) {
			let span = document.createElement('span');
			span.innerHTML = 'âœ“ Same as Owner';
			add_row_tag(address_row, span);
		} else {
			let owner_row = create_row('Owner');
			owner_row.classList.add('owner');
			owner_row.append(create_etherscan_address_link(owner));
			add_row_tag(owner_row, create_elapsed());
			output_append(owner_row);
		}
	}

	// reverse-lookup the address
	let reverse_name;
	try {
		reverse_name = await name.get_primary();
	} catch (err) {
		output_append(create_error_row('Reverse', err.message));
		return;
	}
	if (resolve_timer) return;

	// check if not primary
	if (!reverse_name) {
		let row = create_row('Reverse');
		let span = document.createElement('span');
		apply_warn_grade(span, 'Primary ENS Name Not Set');
		add_row_tag(row, span);
		output_append(row);
		return;
	}

	// adjust the grade
	if (input_name === reverse_name && !input_grade.classList.contains('best')) {
		apply_best_grade(input_grade, 'Matches Reverse');
	}

	// create reverse row
	let reverse_name_row = create_exploded_row('Reverse', reverse_name, true);
	add_row_tag(reverse_name_row, create_elapsed());
	if (input_norm === reverse_name) { 
		let span = document.createElement('span');
		span.innerHTML = 'âœ“ Same as Normalized';
		add_row_tag(reverse_name_row, span);
	} else if (input_norm) { // we might not have a norm
		let span = document.createElement('span');
		apply_warn_grade(span, 'Different from Input');
		add_row_tag(reverse_name_row, span);
	}
	output_append(reverse_name_row);
	
	// stop if theres nothing more to do
	if (input_norm === reverse_name) return;

	// add hashes because they're different
	let reverse_hashes = create_hashes_row(reverse_name);

	// normalize the reverse name
	let reverse_norm;
	try {
		reverse_norm = ens_normalize(reverse_name);
	} catch (err) {
		output_append(create_error_row('Normalized Reverse', err.message));
		return;
	}	

	// create reverse norm row
	let reverse_norm_row = create_exploded_row('Normalized Reverse', reverse_norm, true);
	reverse_norm_row.classList.add('normalized');
	if (reverse_name === reverse_norm) {
		let span = document.createElement('span');
		span.classList.add('good');
		span.innerHTML = 'Normalized';
		add_row_tag(reverse_name_row, span);
	}

	// add some helpers since reverse != input
	add_row_tag(reverse_norm_row, create_copy_btn(reverse_norm));
	add_row_tag(reverse_norm_row, create_ens_link(reverse_norm));

	// make it easy to resolve this new name
	let again_btn = document.createElement('button');
	again_btn.classList.add('main');
	again_btn.innerHTML = 'Resolve';	
	again_btn.addEventListener('click', () => {
		input_field.value = reverse_name;
		resolve();
	});
	add_row_tag(reverse_norm_row, again_btn);	
	output_append(reverse_norm_row);

	if (reverse_name === reverse_norm) {
		output_append(reverse_hashes); // steal from above
 	} else {
		output_append(create_hashes_row(reverse_norm)); // add because different
	}
}
</script>
</body>
</html>